---
title: "n1 2D analysis exp5 exp7 combined: QC and monocle analysis"
author: "Elisa Balmas PhD"
date: "2024-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up environment

```{r}
library(pals)
library(see)
library(monocle3)
library(tidyr)
library(stringr)
library(grid)
library(viridis)
library(viridisLite)
library(ggthemes)
library(dplyr)
library(tidyverse)
library(ggsignif)
library(umap)
library(heatmap3)
library(plyr)
library(edgeR)
library(compareGroups)
library(dbscan)
library(MAST)
library(geosphere)
library(RColorBrewer)
library(Seurat)
library(htmlwidgets)
library(Matrix)
library(tidyseurat)
library(SeuratWrappers)
library(scMAGeCK)
library(readxl)
library(deepToolsUtils)
library(R.utils)


library(ggplot2); library(reshape2); theme_set(theme_bw(26) + theme(panel.grid.major = element_blank(), 
                                                                    panel.grid.minor = element_blank()) +
                                                 theme(legend.key = element_blank()))
update_geom_defaults("point", aes(size = 4))

#setwd("/home/ebalmas/scpHUB/projects/H001AS7_iKDseq_10X_4tp_monocle/analysis_EB")

# Session options
options(stringsAsFactors = FALSE)
set.seed(12345)

# Set up the ggplot default params
theme_set(theme_bw(12) + 
          theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                plot.title = element_text(size=15, face="bold", margin = margin(10,0,10,0)),
                axis.text.x = element_text(angle=45, hjust = 1)))


# Set up filename prefixes and output folders with the data
dir.create("Output")
dir.create(file.path("Output","scratch"))
dir.create(file.path("Output","Meso"))#create forders MONOCLE
dir.create(file.path("Output","Meso","SIDE2"))#create forders MONOCLE
dir.create(file.path("Output","Meso","SIDE2","monocle"))#create forders MONOCLE
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d")))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "R_objects"))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "dotplots"))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "cumulative"))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "dotplots","single"))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "stat"))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "csv"))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "UMAP"))
dir.create(file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "mosaic"))


fname_scratch <- file.path("Output","scratch")

#set up forder path MONOCLE
fname_prefix_R <- file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "R_objects", 
                               format(Sys.Date(), "%y%m%d"))
fname_prefix_dotplot <- file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "dotplots", 
                                                 format(Sys.Date(), "%y%m%d"))
fname_prefix_cumulative <- file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "cumulative", 
                                                 format(Sys.Date(), "%y%m%d"))
fname_prefix_dotplot_single <- file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "dotplots", "single", 
                                                 format(Sys.Date(), "%y%m%d"))
fname_prefix_csv<-file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "csv", 
                               format(Sys.Date(), "%y%m%d"))
fname_prefix_stat<-file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "stat", 
                               format(Sys.Date(), "%y%m%d"))
fname_prefix_UMAP<-file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "UMAP", 
                               format(Sys.Date(), "%y%m%d"))
fname_prefix_mosaic<-file.path("Output","Meso","SIDE2","monocle", format(Sys.Date(), "%y%m%d"), "mosaic", 
                               format(Sys.Date(), "%y%m%d"))


pal <- c("#000000","#004949","#009292","#ff6db6","#ffb6db",
         "#490092","#006ddb","#b66dff","#6db6ff","#b6dbff",
         "#920000","#924900","#db6d00","#24ff24","#ffff6d")
okabe_pal=c("#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7","#000000","#b6dbff","#004949")

pal_26=alphabet2(n=26)


```
#load data
#######load only sub-clustered data

```{r}
load("Output/Meso/monocle/240314/R_objects/240314_monocle_cds_meso_subclustered_FINAL.RData")

ID_key=read_excel(paste0(fname_scratch,"/shRNA_IDs.xlsx"))
ID_shRNA=ID_key%>%dplyr::select(shRNA_ID_unified, shRNA,shRNA_BC,shRNA_label,hex, col_name)
order_cell_types=c("P-PE","PE-1","PE-2","PS","P-PS")

meta=as.data.frame(cds@colData@listData)
meta <- replace(meta, is.na(meta), "empty")
meta=meta%>%left_join(ID_shRNA, by=c("shRNA_ID_unified", "shRNA","shRNA_BC"))#36019
cds@colData$shRNA_label=meta$shRNA_label
cds@colData$hex=meta$hex
cds@colData$col_name=meta$col_name

meta_meso <- replace(meta_meso, is.na(meta_meso), "empty")
meta_meso=meta_meso%>%left_join(ID_shRNA, by=c("shRNA_ID_unified", "shRNA","shRNA_BC"))#15862
cds_meso@colData$shRNA_label=meta_meso$shRNA_label
cds_meso@colData$hex=meta_meso$hex
cds_meso@colData$col_name=meta_meso$col_name

cds=cds[,cds$side=="Side2"]
cds_meso=cds_meso[,cds_meso$side=="Side2"]

meta=subset(meta,meta$side=="Side2")
meta_meso=subset(meta_meso,meta_meso$side=="Side2")


order_genes=c("empty","SCR","B2M","CHD7","GATA4","SMAD2","NKX2.5","KMT2D")
order_genes_2=c("NA","SCR","B2M","CHD7","GATA4","SMAD2","NKX2.5","KMT2D")

###makea df for color code
order_cell_types_long=c("Proliferating posterior epiblast", "Posterior epiblast 1","Posterior epiblast 2","Primitive streak","Proliferating Primitive streak")
order_cell_types=c("P-PE","PE-1","PE-2","PS","P-PS")
order_monocle_short=c(1,3,4,5,2)
order_monocle_long=c(4,1,2,3,5)

okabe_clust=c("#E69F00","#56B4E9","#009E73","#0072B2","#D55E00")
cell_type_pal=data.frame(order_cell_types=order_cell_types,order_cell_types_long=order_cell_types_long,okabe_clust=okabe_clust,order_monocle_short=order_monocle_short,order_monocle_long=order_monocle_long)

cell_type_pal_ms=cell_type_pal[order(cell_type_pal$order_monocle_short),]
cell_type_pal_ml=cell_type_pal[order(cell_type_pal$order_monocle_long),]

okabe_clust=c("#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7","gray","#000000")


col_genes=ID_key%>%select(shRNA_gene,okabe_hex)%>%filter(shRNA_gene%in%order_genes)%>%distinct(shRNA_gene,okabe_hex)
col_genes$order=ifelse(col_genes$shRNA_gene=="CHD7", 4,
                       ifelse(col_genes$shRNA_gene=="empty", 1,
                              ifelse(col_genes$shRNA_gene=="SCR", 2,
                            ifelse(col_genes$shRNA_gene=="GATA4", 5,
                                   ifelse(col_genes$shRNA_gene=="KMT2D", 6,
                                          ifelse(col_genes$shRNA_gene=="NKX2.5", 7,
                                                 ifelse(col_genes$shRNA_gene=="SMAD2", 8,3)))))))
col_genes=col_genes[order(col_genes$order),]

Rdata_filename = paste0(fname_prefix_R, "_monocle_cds_D6_D12_D23_renamed_pseudotime_FINAL_SIDE2.RData")
save(cds,cds_meso,meta,meta_meso,cell_type_pal,ID_key,ID_shRNA,col_genes,cell_type_pal_ms,cell_type_pal_ml,order_cell_types,
     file = Rdata_filename)

cds_meso_sub= cds_meso[,cds_meso@colData@listData[["cell_type_short"]]!="P-PE"&cds_meso@colData@listData[["cell_type_short"]]!="P-PS"]
meta_meso_sub=as.data.frame(cds_meso_sub@colData)

plot_cells(cds_meso_sub, color_cells_by="pseudotime", label_cell_groups = F,group_label_size = 7,label_roots=F,label_leaves=F,label_branch_points=F,cell_size=0.8)+
  scale_color_viridis(discrete=F, option="A")+
  labs(x = "UMAP 1", y = "UMAP 2", title = "Monocle pseudotime Mesoderm")
ggsave(filename = paste0(fname_prefix_UMAP, "_", "UMAP_pseudotime_SUB.pdf"),
     width = 5, height = 4)

cds_meso_sub<- order_cells(cds_meso_sub,reduction_method = "UMAP")

```


## mosaic plots of the late timepoints
####plots by gene (no distinction by shRNA)

```{r}

#meta_meso$gene_new
meta_meso$gene_new=ifelse(meta_meso$shRNA_gene=="CHD7", "CHD7",
                            ifelse(meta_meso$shRNA_gene=="GATA4", "GATA4",
                                   ifelse(meta_meso$shRNA_gene=="KMT2D", "KMT2D",
                                          ifelse(meta_meso$shRNA_gene=="NKX2.5", "NKX2.5",
                                                 ifelse(meta_meso$shRNA_gene=="SMAD2", "SMAD2","control")))))

#update cds file
colData(cds_meso)$gene_polish=meta_meso$gene_new

Ps_all=as.data.frame(pseudotime(cds_meso, reduction_method = "UMAP"))
colnames(Ps_all)="pseudotime"
cds_meso@colData$pseudotime=Ps_all$pseudotime

#update full meta and divide between timepoints
meta_meso=as.data.frame(cds_meso@colData)




```
########
#make plots for cumulative frequency

```{r}

#ggplot(to.plot.set, aes(pseudotime, colour = gene)) + stat_ecdf()+ facet_grid(~day)
ggplot(meta_meso, aes(pseudotime, colour = factor(shRNA_gene,levels=col_genes$shRNA_gene))) +
  stat_ecdf(geom = "step")+ 
  scale_color_manual(name = "gene",values = col_genes$okabe_hex)+
  ylab("Cumulative frequency")+
  ggtitle("Cumulative frequency by gene")+
  facet_grid(~sample_ID)


ggsave(filename = paste0(fname_prefix_dotplot, "_", "cumulative_frequency.png"),
     width = 14, height = 14)


gene_names <- c("CHD7", "GATA4", "KMT2D", "NKX2.5", "SMAD2")

for (gene_name in gene_names) {
  gene_subset <- subset(meta_meso, meta_meso$shRNA_gene %in% c("B2M", "SCR", gene_name))

  ggplot(gene_subset, aes(pseudotime, colour = factor(shRNA_gene, c("B2M", "SCR", gene_name)))) +
    stat_ecdf(geom = "step") +
    scale_color_okabeito(name = "gene") +
    theme_classic(base_size = 14) +
    labs(
      x = "pseudotime",
      y = "Cumulative frequency",
      color = "gene"  # Legend title
    ) +
    ggtitle(paste("Cumulative frequency", gene_name, "clones")) +
    facet_grid(~sample_ID)

  ggsave(
    filename = paste0(fname_prefix_cumulative, "_", "cumulative_frequency_", gene_name, ".png"),
    width = 6, height = 8
  )
}

gene_names <- c("CHD7", "GATA4", "KMT2D", "NKX2.5", "SMAD2")

for (gene_name in gene_names) {
  gene_subset <- subset(meta_meso_sub, meta_meso_sub$shRNA_gene %in% c("B2M", "SCR", gene_name))

  ggplot(gene_subset, aes(pseudotime, colour = factor(shRNA_gene, c("B2M", "SCR", gene_name)))) +
    stat_ecdf(geom = "step") +
    scale_color_okabeito(name = "gene") +
    theme_classic(base_size = 14) +
    labs(
      x = "pseudotime",
      y = "Cumulative frequency",
      color = "gene"  # Legend title
    ) +
    ggtitle(paste("Cumulative frequency", gene_name, "clones")) +
    facet_grid(~sample_ID)

  ggsave(
    filename = paste0(fname_prefix_cumulative, "_", "cumulative_frequency_SUB_", gene_name, ".png"),
    width = 6, height = 8
  )
}

```
######ks statistics
##analysis for genes
```{r}

meta=meta_meso
# List of genes
genes <- c("B2M", "SCR", "CHD7", "GATA4", "KMT2D", "NKX2.5", "SMAD2")

# Initialize an empty data frame to store results
ks.stat <- data.frame(
  genes = character(),
  pval_vs_SCR = numeric(),
  padj_vs_SCR = numeric(),
  pval_vs_B2M = numeric(),
  padj_vs_B2M = numeric(),
  pval_greater_SCR= numeric(),
  pval_less_SCR= numeric(),
  ks_sign_SCR= numeric(),
  ks_greater_SCR= numeric(),
  ks_less_SCR= numeric(),
  pval_greater_B2M= numeric(),
  pval_less_B2M= numeric(),
  ks_sign_B2M= numeric(),
  ks_greater_B2m= numeric(),
  ks_less_B2M= numeric(),
  stringsAsFactors = FALSE
)

# Loop through genes
for (gene in genes) {
  # Subset data for the current gene
  gene_ecdf <- subset(meta,meta$shRNA_gene == gene)
  gene_ecdf <- gene_ecdf$pseudotime

  # Subset SCR data
  SCR_ecdf <- subset(meta, meta$shRNA_gene == "SCR")
  SCR_ecdf <- SCR_ecdf$pseudotime
  
  # Subset B2M data
  B2M_ecdf <- subset(meta, meta$shRNA_gene == "B2M")
  B2M_ecdf <- B2M_ecdf$pseudotime

  # Perform ks.test
  ks.controls <- ks.test(gene_ecdf, SCR_ecdf)
  ks.controls_g <- ks.test(gene_ecdf, SCR_ecdf,alternative="greater")
  ks.controls_l <- ks.test(gene_ecdf, SCR_ecdf,alternative="less")
  
  ks.b2m <- ks.test(B2M_ecdf, gene_ecdf)
  ks.b2m_g <- ks.test(B2M_ecdf, gene_ecdf,alternative="greater")
  ks.b2m_l <- ks.test(B2M_ecdf, gene_ecdf,alternative="less")

  # Calculate adjusted p-values
  adj_vs_SCR <- p.adjust(ks.controls$p.value, method = "BH")
  adj_vs_B2M <- p.adjust(ks.b2m$p.value, method = "BH")

  # Append results to the data frame
  ks.stat <- bind_rows(
    ks.stat,
    data.frame(
      genes = gene,
      pval_vs_SCR = ks.controls$p.value,
      padj_vs_SCR = adj_vs_SCR,
      pval_greater_SCR=ks.controls_g[["p.value"]],
      pval_less_SCR=ks.controls_l[["p.value"]],
      ks_sign_SCR=ks.controls[["statistic"]][["D"]],
      ks_greater_SCR=ks.controls_g[["statistic"]][["D^+"]],
      ks_less_SCR=ks.controls_l[["statistic"]][["D^-"]],
      
      pval_vs_B2M = ks.b2m$p.value,
      padj_vs_B2M = adj_vs_B2M,
      pval_greater_B2M=ks.b2m_g[["p.value"]],
      pval_less_B2M=ks.b2m_l[["p.value"]],
      ks_sign_B2M=ks.b2m[["statistic"]][["D"]],
      ks_greater_B2m=ks.b2m_g[["statistic"]][["D^+"]],
      ks_less_B2M=ks.b2m_l[["statistic"]][["D^-"]]
    )
  )
}

# Add additional columns
ks.stat$sig_vs_SCR <- ks.stat$padj_vs_SCR <= 0.05
ks.stat$sig_vs_B2M <- ks.stat$padj_vs_B2M <= 0.05
ks.stat$greater_SCR <- ks.stat$pval_greater_SCR <= 0.05
ks.stat$less_SCR <- ks.stat$pval_less_SCR <= 0.05
ks.stat$greater_B2M <- ks.stat$pval_greater_B2M  <= 0.05
ks.stat$less_B2M <- ks.stat$pval_less_B2M  <= 0.05

ks.stat$k_sign_summary_SCR <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_SCR & !ks.stat$less_SCR,
  as.numeric(ks.stat$ks_sign_SCR),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_SCR & ks.stat$less_SCR,
    -as.numeric(ks.stat$ks_sign_SCR),  # Return negative of ks_sign
    ks.stat$ks_sign_SCR  # Otherwise, return 0
  )
)

ks.stat$k_sign_summary_B2M <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_B2M & !ks.stat$less_B2M,
  as.numeric(ks.stat$ks_sign_B2M),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_B2M & ks.stat$less_B2M,
    -as.numeric(ks.stat$ks_sign_B2M),  # Return negative of ks_sign
    ks.stat$ks_sign_B2M  # Otherwise, return 0
  )
)

ks.stat= replace(ks.stat, is.na(ks.stat), "empty")

ks.stat$k_colour_SCR <- ifelse(
ks.stat$sig_vs_SCR==T,ks.stat$genes,"") 

ks.genes=ks.stat
write.csv(ks.genes, file= paste0(fname_prefix_csv, "_", "D6_ks.stat_genes_meso.csv"), row.names=T)

##########analyze subclusters without proliferating clusters

meta=meta_meso_sub
# List of genes
genes <- c("B2M", "SCR", "CHD7", "GATA4", "KMT2D", "NKX2.5", "SMAD2")

# Initialize an empty data frame to store results
ks.stat <- data.frame(
  genes = character(),
  pval_vs_SCR = numeric(),
  padj_vs_SCR = numeric(),
  pval_vs_B2M = numeric(),
  padj_vs_B2M = numeric(),
  pval_greater_SCR= numeric(),
  pval_less_SCR= numeric(),
  ks_sign_SCR= numeric(),
  ks_greater_SCR= numeric(),
  ks_less_SCR= numeric(),
  pval_greater_B2M= numeric(),
  pval_less_B2M= numeric(),
  ks_sign_B2M= numeric(),
  ks_greater_B2m= numeric(),
  ks_less_B2M= numeric(),
  stringsAsFactors = FALSE
)

# Loop through genes
for (gene in genes) {
  # Subset data for the current gene
  gene_ecdf <- subset(meta,meta$shRNA_gene == gene)
  gene_ecdf <- gene_ecdf$pseudotime

  # Subset SCR data
  SCR_ecdf <- subset(meta, meta$shRNA_gene == "SCR")
  SCR_ecdf <- SCR_ecdf$pseudotime
  
  # Subset B2M data
  B2M_ecdf <- subset(meta, meta$shRNA_gene == "B2M")
  B2M_ecdf <- B2M_ecdf$pseudotime

  # Perform ks.test
  ks.controls <- ks.test(gene_ecdf, SCR_ecdf)
  ks.controls_g <- ks.test(gene_ecdf, SCR_ecdf,alternative="greater")
  ks.controls_l <- ks.test(gene_ecdf, SCR_ecdf,alternative="less")
  
  ks.b2m <- ks.test(B2M_ecdf, gene_ecdf)
  ks.b2m_g <- ks.test(B2M_ecdf, gene_ecdf,alternative="greater")
  ks.b2m_l <- ks.test(B2M_ecdf, gene_ecdf,alternative="less")

  # Calculate adjusted p-values
  adj_vs_SCR <- p.adjust(ks.controls$p.value, method = "BH")
  adj_vs_B2M <- p.adjust(ks.b2m$p.value, method = "BH")

  # Append results to the data frame
  ks.stat <- bind_rows(
    ks.stat,
    data.frame(
      genes = gene,
      pval_vs_SCR = ks.controls$p.value,
      padj_vs_SCR = adj_vs_SCR,
      pval_greater_SCR=ks.controls_g[["p.value"]],
      pval_less_SCR=ks.controls_l[["p.value"]],
      ks_sign_SCR=ks.controls[["statistic"]][["D"]],
      ks_greater_SCR=ks.controls_g[["statistic"]][["D^+"]],
      ks_less_SCR=ks.controls_l[["statistic"]][["D^-"]],
      
      pval_vs_B2M = ks.b2m$p.value,
      padj_vs_B2M = adj_vs_B2M,
      pval_greater_B2M=ks.b2m_g[["p.value"]],
      pval_less_B2M=ks.b2m_l[["p.value"]],
      ks_sign_B2M=ks.b2m[["statistic"]][["D"]],
      ks_greater_B2m=ks.b2m_g[["statistic"]][["D^+"]],
      ks_less_B2M=ks.b2m_l[["statistic"]][["D^-"]]
    )
  )
}

# Add additional columns
ks.stat$sig_vs_SCR <- ks.stat$padj_vs_SCR <= 0.05
ks.stat$sig_vs_B2M <- ks.stat$padj_vs_B2M <= 0.05
ks.stat$greater_SCR <- ks.stat$pval_greater_SCR <= 0.05
ks.stat$less_SCR <- ks.stat$pval_less_SCR <= 0.05
ks.stat$greater_B2M <- ks.stat$pval_greater_B2M  <= 0.05
ks.stat$less_B2M <- ks.stat$pval_less_B2M  <= 0.05

ks.stat$k_sign_summary_SCR <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_SCR & !ks.stat$less_SCR,
  as.numeric(ks.stat$ks_sign_SCR),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_SCR & ks.stat$less_SCR,
    -as.numeric(ks.stat$ks_sign_SCR),  # Return negative of ks_sign
    ks.stat$ks_sign_SCR  # Otherwise, return 0
  )
)

ks.stat$k_sign_summary_B2M <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_B2M & !ks.stat$less_B2M,
  as.numeric(ks.stat$ks_sign_B2M),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_B2M & ks.stat$less_B2M,
    -as.numeric(ks.stat$ks_sign_B2M),  # Return negative of ks_sign
    ks.stat$ks_sign_B2M  # Otherwise, return 0
  )
)

ks.stat= replace(ks.stat, is.na(ks.stat), "empty")

ks.stat$k_colour_SCR <- ifelse(
ks.stat$sig_vs_SCR==T,ks.stat$genes,"") 

ks.genes_sub=ks.stat
write.csv(ks.genes_sub, file= paste0(fname_prefix_csv, "_", "D6_ks.stat_genes_meso_sub.csv"), row.names=T)

```



#####make volcano plot
ks genes
```{r}

ks.genes$k_colour_SCR_all <- ifelse(
ks.genes$sig_vs_SCR==T,ks.genes$genes,"NS") 


data=subset(ks.genes,ks.genes$genes!="B2M"&ks.genes$genes!="SCR"&ks.genes$genes!="empty")
g=data%>%select(genes)%>%distinct(genes)###make sure you have all the genes
p=col_genes%>%filter(shRNA_gene%in%g$genes)

ggplot(data=subset(ks.genes,ks.genes$genes!="B2M"&ks.genes$genes!="SCR"&ks.genes$genes!="empty"), aes(x=k_sign_summary_SCR, y=log10(padj_vs_SCR+1e-20)*-1)) +
  geom_point(aes(colour = factor(genes,levels=p$shRNA_gene)), size=2)+
  scale_colour_manual(values=c(p$okabe_hex))+
  ggrepel::geom_text_repel(
    data = subset(ks.genes,ks.genes$genes!="B2M"&ks.genes$genes!="SCR"&ks.genes$genes!="empty"&ks.genes$sig_vs_SCR==T),
    aes(label = genes),
    size = 4,
    #max.overlaps=50,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  )+
  xlim(-1,1)+
  #ylim(0,40)+
  geom_hline(yintercept = log10(0.05)*-1,linetype="dotted", color="red")+
  geom_vline(xintercept = 0,linetype="dotted")+
  ggtitle("ks test statistics KD genes")+
  theme_minimal() +  # You can change the theme as needed
  labs(
    x = "KS statistic summary",
    y = "-Log10 adj p-value",
    color = "genes"  # Legend title
  ) 

ggsave(filename = paste0(fname_prefix_dotplot, "_volcano_ks_stats_genes.pdf"),
       width = 7, height = 4)

####subset data

ks.genes_sub$k_colour_SCR_all <- ifelse(
ks.genes_sub$sig_vs_SCR==T,ks.genes_sub$genes,"NS") 

ks.genes_sub$k_colour_B2M_all <- ifelse(
ks.genes_sub$sig_vs_B2M==T,ks.genes_sub$genes,"NS") 



data=subset(ks.genes_sub,ks.genes_sub$genes!="B2M"&ks.genes_sub$genes!="SCR"&ks.genes_sub$genes!="empty")
g=data%>%select(genes)%>%distinct(genes)###make sure you have all the genes
p=col_genes%>%filter(shRNA_gene%in%g$genes)

ggplot(data=subset(ks.genes_sub,ks.genes_sub$genes!="B2M"&ks.genes_sub$genes!="SCR"&ks.genes_sub$genes!="empty"), aes(x=k_sign_summary_B2M, y=log10(padj_vs_B2M)*-1)) +
  geom_point(aes(colour = factor(genes,levels=p$shRNA_gene)), size=2)+
  scale_colour_manual(values=c(p$okabe_hex))+
  ggrepel::geom_text_repel(
    data = subset(ks.genes_sub,ks.genes_sub$genes!="B2M"&ks.genes_sub$genes!="SCR"&ks.genes_sub$genes!="empty"&ks.genes_sub$sig_vs_B2M==T),
    aes(label = genes),
    size = 4,
    #max.overlaps=50,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  )+
  #xlim(-1,1)+
  #ylim(0,40)+
  geom_hline(yintercept = log10(0.05)*-1,linetype="dotted", color="red")+
  geom_vline(xintercept = 0,linetype="dotted")+
  ggtitle("ks test statistics KD genes vs B2M")+
  theme_minimal() +  # You can change the theme as needed
  labs(
    x = "KS statistic summary",
    y = "-Log10 adj p-value",
    color = "genes"  # Legend title
  ) 

ggsave(filename = paste0(fname_prefix_dotplot, "_volcano_ks_stats_genes_sub.pdf"),
       width = 7, height = 4)

```


####Now make the analysis by shRNA
##pre select shRNA

```{r}

######pre select shRNA
###use metaD12 and metaD23 with selection of clusters 
tot_shRNA=as.data.frame(table(meta_meso$shRNA_ID))
colnames(tot_shRNA)=c("shRNA_ID","tot_shRNA")
tot_shRNA$select_sh=tot_shRNA$tot_shRNA>=70

stat_filename = paste0(fname_prefix_stat, "_tot_freq_cells_by_shRNA_cardio_for_cumulative_freq.csv")
write.csv(tot_shRNA, stat_filename, quote = F, row.names = T, sep=",")

###add data on meta
meta_meso <- replace(meta_meso, is.na(meta_meso), "empty")
meta_meso$shRNA_polished=recode(meta_meso$shRNA_ID,"empty"="control",
                                   "B2M"="control","SCR"="control")
empty_T=data.frame(shRNA_ID="empty","select_sh"=T)
t=tot_shRNA%>%dplyr::select(shRNA_ID,select_sh)
t=rbind(t,empty_T)

meta_meso=meta_meso%>%left_join(t,by="shRNA_ID")

meta_shRNA=subset(meta_meso,meta_meso$select_sh==T)
meta_shRNA_sub=subset(meta_shRNA,meta_shRNA$cell_type_short!="P-PE"&meta_shRNA$cell_type_short!="P-PS")
```

####make cumulative plots 
##shRNA
```{r}
gene_names <- c("CHD7", "GATA4", "KMT2D", "NKX2.5", "SMAD2")
colors <- c("#ff6db6","#b66dff", "darkblue", "darkgreen", "orange", "red")
shRNA=unique(meta_shRNA$shRNA_ID)

for (gene_name in gene_names) {
  gene_subset <- subset(meta_shRNA, meta_shRNA$shRNA_gene %in% c("B2M", "SCR", gene_name))

  ggplot(gene_subset, aes(pseudotime, colour =shRNA_ID_unified)) +
    stat_ecdf(geom = "step") +
    scale_colour_manual(values = c("grey", colors)) +
    theme_classic(base_size = 14) +
    labs(
      x = "pseudotime",
      y = "Cumulative frequency",
      color = "gene"  # Legend title
    ) +
    ggtitle(paste("Cumulative frequency", gene_name, "clones")) +
    facet_grid(~sample_ID)

  ggsave(
    filename = paste0(fname_prefix_cumulative, "_", "cumulative_frequency_shRNA_", gene_name, ".png"),
    width = 12, height = 8
  )
}

gene_names <- c("CHD7", "GATA4", "KMT2D", "NKX2.5", "SMAD2")
colors <- c("#ff6db6","#b66dff", "darkblue", "darkgreen", "orange", "red")
shRNA=unique(meta_shRNA_sub$shRNA_ID)

for (gene_name in gene_names) {
  gene_subset <- subset(meta_shRNA_sub, meta_shRNA_sub$shRNA_gene %in% c("B2M", "SCR", gene_name))

  ggplot(gene_subset, aes(pseudotime, colour =shRNA_ID_unified)) +
    stat_ecdf(geom = "step") +
    scale_colour_manual(values = c("grey", colors)) +
    theme_classic(base_size = 14) +
    labs(
      x = "pseudotime",
      y = "Cumulative frequency",
      color = "gene"  # Legend title
    ) +
    ggtitle(paste("Cumulative frequency", gene_name, "clones")) +
    facet_grid(~sample_ID)

  ggsave(
    filename = paste0(fname_prefix_cumulative, "_", "sub_cumulative_frequency_shRNA_", gene_name, ".png"),
    width = 12, height = 8
  )
}
```
 
######ks statistics
#####analysis for shRNA

```{r}
#calculate stats day 6
meta=meta_shRNA
# List of genes

genes=unique(meta$shRNA_ID_unified)

# Initialize an empty data frame to store results
ks.stat <- data.frame(
  genes = character(),
  pval_vs_SCR = numeric(),
  padj_vs_SCR = numeric(),
  pval_vs_B2M = numeric(),
  padj_vs_B2M = numeric(),
  pval_greater_SCR= numeric(),
  pval_less_SCR= numeric(),
  ks_sign_SCR= numeric(),
  ks_greater_SCR= numeric(),
  ks_less_SCR= numeric(),
  pval_greater_B2M= numeric(),
  pval_less_B2M= numeric(),
  ks_sign_B2M= numeric(),
  ks_greater_B2m= numeric(),
  ks_less_B2M= numeric(),
  stringsAsFactors = FALSE
)

# Loop through genes
for (gene in genes) {
  # Subset data for the current gene
  gene_ecdf <- subset(meta, meta$shRNA_ID_unified == gene)
  gene_ecdf <- gene_ecdf$pseudotime

  # Subset SCR data
  SCR_ecdf <- subset(meta, meta$shRNA_gene == "SCR")
  SCR_ecdf <- SCR_ecdf$pseudotime
  B2M_ecdf <- subset(meta, meta$shRNA_gene == "B2M")
  B2M_ecdf <- B2M_ecdf$pseudotime

  # Perform ks.test
  ks.controls <- ks.test(gene_ecdf, SCR_ecdf)
  ks.controls_g <- ks.test(gene_ecdf, SCR_ecdf,alternative="greater")
  ks.controls_l <- ks.test(gene_ecdf, SCR_ecdf,alternative="less")
  
  ks.b2m <- ks.test(B2M_ecdf, gene_ecdf)
  ks.b2m_g <- ks.test(B2M_ecdf, gene_ecdf,alternative="greater")
  ks.b2m_l <- ks.test(B2M_ecdf, gene_ecdf,alternative="less")

  # Calculate adjusted p-values
  adj_vs_SCR <- p.adjust(ks.controls$p.value, method = "BH")
  adj_vs_B2M <- p.adjust(ks.b2m$p.value, method = "BH")

  # Append results to the data frame
  ks.stat <- bind_rows(
    ks.stat,
    data.frame(
      genes = gene,
      pval_vs_SCR = ks.controls$p.value,
      padj_vs_SCR = adj_vs_SCR,
      pval_greater_SCR=ks.controls_g[["p.value"]],
      pval_less_SCR=ks.controls_l[["p.value"]],
      ks_sign_SCR=ks.controls[["statistic"]][["D"]],
      ks_greater_SCR=ks.controls_g[["statistic"]][["D^+"]],
      ks_less_SCR=ks.controls_l[["statistic"]][["D^-"]],
      
      pval_vs_B2M = ks.b2m$p.value,
      padj_vs_B2M = adj_vs_B2M,
      pval_greater_B2M=ks.b2m_g[["p.value"]],
      pval_less_B2M=ks.b2m_l[["p.value"]],
      ks_sign_B2M=ks.b2m[["statistic"]][["D"]],
      ks_greater_B2m=ks.b2m_g[["statistic"]][["D^+"]],
      ks_less_B2M=ks.b2m_l[["statistic"]][["D^-"]]
    )
  )
}

# Add additional columns
ks.stat$sig_vs_SCR <- ks.stat$padj_vs_SCR <= 0.05
ks.stat$sig_vs_B2M <- ks.stat$padj_vs_B2M <= 0.05
ks.stat$greater_SCR <- ks.stat$pval_greater_SCR <= 0.05
ks.stat$less_SCR <- ks.stat$pval_less_SCR <= 0.05
ks.stat$greater_B2M <- ks.stat$pval_greater_B2M  <= 0.05
ks.stat$less_B2M <- ks.stat$pval_less_B2M  <= 0.05

ks.stat$k_sign_summary_SCR <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_SCR & !ks.stat$less_SCR,
  as.numeric(ks.stat$ks_sign_SCR),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_SCR & ks.stat$less_SCR,
    -as.numeric(ks.stat$ks_sign_SCR),  # Return negative of ks_sign
    ks.stat$ks_sign_SCR  # Otherwise, return 0
  )
)

ks.stat$k_sign_summary_B2M <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_B2M & !ks.stat$less_B2M,
  as.numeric(ks.stat$ks_sign_B2M),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_B2M & ks.stat$less_B2M,
    -as.numeric(ks.stat$ks_sign_B2M),  # Return negative of ks_sign
    ks.stat$ks_sign_B2M  # Otherwise, return 0
  )
)

ks.stat= replace(ks.stat, is.na(ks.stat), "empty")

ks.stat=ks.stat%>%dplyr::rename(shRNA_ID_unified=genes)
ks.stat=ks.stat%>%left_join(ID_shRNA, by="shRNA_ID_unified")

ks.stat$k_colour_SCR <- ifelse(
ks.stat$sig_vs_SCR==T,ks.stat$shRNA_label,"") 

ks.stat$k_colour_palette <- ifelse(
ks.stat$sig_vs_SCR==T,ks.stat$hex,"grey") 

ks.shRNA=ks.stat

write.csv(ks.shRNA, file= paste0(fname_prefix_csv, "_", "ks_stat_shRNA.csv"), row.names=T)

################subset analysis

#calculate stats day 6
meta=meta_shRNA_sub
# List of genes

genes=unique(meta$shRNA_ID_unified)

# Initialize an empty data frame to store results
ks.stat <- data.frame(
  genes = character(),
  pval_vs_SCR = numeric(),
  padj_vs_SCR = numeric(),
  pval_vs_B2M = numeric(),
  padj_vs_B2M = numeric(),
  pval_greater_SCR= numeric(),
  pval_less_SCR= numeric(),
  ks_sign_SCR= numeric(),
  ks_greater_SCR= numeric(),
  ks_less_SCR= numeric(),
  pval_greater_B2M= numeric(),
  pval_less_B2M= numeric(),
  ks_sign_B2M= numeric(),
  ks_greater_B2m= numeric(),
  ks_less_B2M= numeric(),
  stringsAsFactors = FALSE
)

# Loop through genes
for (gene in genes) {
  # Subset data for the current gene
  gene_ecdf <- subset(meta, meta$shRNA_ID_unified == gene)
  gene_ecdf <- gene_ecdf$pseudotime

  # Subset SCR data
  SCR_ecdf <- subset(meta, meta$shRNA_gene == "SCR")
  SCR_ecdf <- SCR_ecdf$pseudotime
  B2M_ecdf <- subset(meta, meta$shRNA_gene == "B2M")
  B2M_ecdf <- B2M_ecdf$pseudotime

  # Perform ks.test
  ks.controls <- ks.test(gene_ecdf, SCR_ecdf)
  ks.controls_g <- ks.test(gene_ecdf, SCR_ecdf,alternative="greater")
  ks.controls_l <- ks.test(gene_ecdf, SCR_ecdf,alternative="less")
  
  ks.b2m <- ks.test(B2M_ecdf, gene_ecdf)
  ks.b2m_g <- ks.test(B2M_ecdf, gene_ecdf,alternative="greater")
  ks.b2m_l <- ks.test(B2M_ecdf, gene_ecdf,alternative="less")

  # Calculate adjusted p-values
  adj_vs_SCR <- p.adjust(ks.controls$p.value, method = "BH")
  adj_vs_B2M <- p.adjust(ks.b2m$p.value, method = "BH")

  # Append results to the data frame
  ks.stat <- bind_rows(
    ks.stat,
    data.frame(
      genes = gene,
      pval_vs_SCR = ks.controls$p.value,
      padj_vs_SCR = adj_vs_SCR,
      pval_greater_SCR=ks.controls_g[["p.value"]],
      pval_less_SCR=ks.controls_l[["p.value"]],
      ks_sign_SCR=ks.controls[["statistic"]][["D"]],
      ks_greater_SCR=ks.controls_g[["statistic"]][["D^+"]],
      ks_less_SCR=ks.controls_l[["statistic"]][["D^-"]],
      
      pval_vs_B2M = ks.b2m$p.value,
      padj_vs_B2M = adj_vs_B2M,
      pval_greater_B2M=ks.b2m_g[["p.value"]],
      pval_less_B2M=ks.b2m_l[["p.value"]],
      ks_sign_B2M=ks.b2m[["statistic"]][["D"]],
      ks_greater_B2m=ks.b2m_g[["statistic"]][["D^+"]],
      ks_less_B2M=ks.b2m_l[["statistic"]][["D^-"]]
    )
  )
}

# Add additional columns
ks.stat$sig_vs_SCR <- ks.stat$padj_vs_SCR <= 0.05
ks.stat$sig_vs_B2M <- ks.stat$padj_vs_B2M <= 0.05
ks.stat$greater_SCR <- ks.stat$pval_greater_SCR <= 0.05
ks.stat$less_SCR <- ks.stat$pval_less_SCR <= 0.05
ks.stat$greater_B2M <- ks.stat$pval_greater_B2M  <= 0.05
ks.stat$less_B2M <- ks.stat$pval_less_B2M  <= 0.05

ks.stat$k_sign_summary_SCR <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_SCR & !ks.stat$less_SCR,
  as.numeric(ks.stat$ks_sign_SCR),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_SCR & ks.stat$less_SCR,
    -as.numeric(ks.stat$ks_sign_SCR),  # Return negative of ks_sign
    ks.stat$ks_sign_SCR  # Otherwise, return 0
  )
)

ks.stat$k_sign_summary_B2M <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_B2M & !ks.stat$less_B2M,
  as.numeric(ks.stat$ks_sign_B2M),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_B2M & ks.stat$less_B2M,
    -as.numeric(ks.stat$ks_sign_B2M),  # Return negative of ks_sign
    ks.stat$ks_sign_B2M  # Otherwise, return 0
  )
)

ks.stat= replace(ks.stat, is.na(ks.stat), "empty")

ks.stat=ks.stat%>%dplyr::rename(shRNA_ID_unified=genes)
ks.stat=ks.stat%>%left_join(ID_shRNA, by="shRNA_ID_unified")

ks.stat$k_colour_SCR <- ifelse(
ks.stat$sig_vs_SCR==T,ks.stat$shRNA_label,"") 

ks.stat$k_colour_palette <- ifelse(
ks.stat$sig_vs_SCR==T,ks.stat$hex,"grey") 

ks.shRNA_sub=ks.stat

write.csv(ks.shRNA_sub, file= paste0(fname_prefix_csv, "_", "ks_stat_shRNA_sub.csv"), row.names=T)

```

#####make volcano plots
###shRNA

```{r}

ks.shRNA$k_colour_SCR_all <- ifelse(
ks.shRNA$sig_vs_SCR==T&ks.shRNA$k_sign_summary_SCR!=0,ks.shRNA$shRNA_label,"NS") 


ggplot(data=subset(ks.shRNA,ks.shRNA$shRNA!="B2M"&ks.shRNA$shRNA!="SCR"&ks.shRNA$shRNA!="empty"), aes(x=k_sign_summary_SCR, y=log10(padj_vs_SCR+1e-15)*-1)) +
  geom_point(aes(colour = k_colour_SCR_all), size=2) +
  scale_colour_manual(values=c(ks.shRNA$k_colour_palette))+
  ggrepel::geom_text_repel(
    data = subset(ks.shRNA, ks.shRNA$shRNA!="B2M"&ks.shRNA$shRNA!="SCR"&ks.shRNA$shRNA!="empty"&ks.shRNA$sig_vs_SCR==T&ks.shRNA$k_sign_summary_SCR!=0),
    aes(label = k_colour_SCR),
    size = 4,
    max.overlaps=50,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  )+
  xlim(-1,1)+
  geom_hline(yintercept = log10(0.05)*-1,linetype="dotted", color="red")+
  geom_vline(xintercept = 0,linetype="dotted")+
  ggtitle("ks test statistics KD shRNA")+
  theme_minimal() +  # You can change the theme as needed
  labs(
    x = "KS statistic summary",
    y = "-Log10 adj p-value",
    color = "shRNA"  # Legend title
  ) 

ggsave(filename = paste0(fname_prefix_dotplot, "_volcano_ks_stats_shRNA.pdf"),
       width = 7, height = 4)



#########subsetting

ks.shRNA_sub$k_colour_SCR_all <- ifelse(
ks.shRNA_sub$sig_vs_SCR==T&ks.shRNA_sub$k_sign_summary_SCR!=0,ks.shRNA_sub$shRNA_label,"NS") 

ks.shRNA_sub$k_colour_B2M_all <- ifelse(
ks.shRNA_sub$sig_vs_B2M==T&ks.shRNA_sub$k_sign_summary_B2M!=0,ks.shRNA_sub$shRNA_label,"NS") 
ks.shRNA_sub$k_colour_B2M <- ifelse(
ks.shRNA_sub$sig_vs_B2M==T&ks.shRNA_sub$k_sign_summary_B2M!=0,ks.shRNA_sub$shRNA_label,"") 



ggplot(data=subset(ks.shRNA_sub,ks.shRNA_sub$shRNA!="B2M"&ks.shRNA_sub$shRNA!="SCR"&ks.shRNA_sub$shRNA!="empty"), aes(x=k_sign_summary_B2M, y=log10(padj_vs_B2M)*-1)) +
  geom_point(aes(colour = k_colour_B2M_all), size=2) +
  scale_colour_manual(values=c(ks.shRNA_sub$k_colour_palette))+
  ggrepel::geom_text_repel(
    data = subset(ks.shRNA_sub, ks.shRNA_sub$shRNA!="B2M"&ks.shRNA_sub$shRNA!="SCR"&ks.shRNA_sub$shRNA!="empty"&ks.shRNA_sub$sig_vs_SCR==T&ks.shRNA_sub$k_sign_summary_B2M!=0),
    aes(label = k_colour_B2M),
    size = 4,
    max.overlaps=50,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  )+
  xlim(-1,1)+
  geom_hline(yintercept = log10(0.05)*-1,linetype="dotted", color="red")+
  geom_vline(xintercept = 0,linetype="dotted")+
  ggtitle("ks test statistics KD shRNA")+
  theme_minimal() +  # You can change the theme as needed
  labs(
    x = "KS statistic summary",
    y = "-Log10 adj p-value",
    color = "shRNA"  # Legend title
  ) 

ggsave(filename = paste0(fname_prefix_dotplot, "_volcano_ks_stats_shRNA_sub.pdf"),
       width = 7, height = 4)
```


##pre select clones 

```{r}

######pre select clones
###use metaD12 and metaD23 with selection of clusters 
tot_clone=as.data.frame(table(meta_meso$clone))
colnames(tot_clone)=c("clone","tot_cl")
tot_clone$select_cl=tot_clone$tot_cl>=70

stat_filename = paste0(fname_prefix_stat, "_tot_freq_cells_by_clone_for_cumulative_freq.csv")
write.csv(tot_clone, stat_filename, quote = F, row.names = T, sep=",")

###add data on meta

t=tot_clone%>%select(clone,select_cl)

meta_meso=meta_meso%>%left_join(t,by="clone")#9020

meta_clone=subset(meta_meso,meta_meso$select_cl==T)#
meta_clone_sub=subset(meta_clone,meta_clone$cell_type_short!="P-PE"&meta_clone$cell_type_short!="P-PS")#

```

######make cumulative plot by clone

```{r}
gene_names <- c("CHD7", "GATA4", "KMT2D", "NKX2.5", "SMAD2")
colors <- c("#ff6db6","#b66dff", "#009E73", "#004949", "#E69F00","#F0E442" ,"#0072B2","#CC79A7","#D55E00")
clone=unique(meta_meso$clone)

for (gene_name in gene_names) {
  gene_subset <- subset(meta_clone, meta_clone$shRNA_gene %in% c("B2M", "SCR", gene_name))

  ggplot(gene_subset, aes(pseudotime, colour =clone)) +
    stat_ecdf(geom = "step") +
    scale_colour_manual(values = c("grey", colors)) +
    theme_classic(base_size = 14) +
    labs(
      x = "pseudotime",
      y = "Cumulative frequency",
      color = "gene"  # Legend title
    ) +
    ggtitle(paste("Cumulative frequency", gene_name, "barcoded clones")) +
    facet_grid(~sample_ID)

  ggsave(
    filename = paste0(fname_prefix_cumulative, "_", "cumulative_frequency_clones_", gene_name, ".png"),
    width = 12, height = 8
  )
}
```


#build clone nomenclature
```{r}
meta=as.data.frame(cds@colData@listData)
cl_ID=read_excel(paste0(fname_scratch,"/clones.xlsx"))

cl_ID$clone_short=paste0("cl",cl_ID$cl_ID," ",cl_ID$shRNA_ID_unified)

```


######ks statistics
#####analysis for clones

```{r}

#calculate stats clones meso
meta=meta_clone
# List of genes

genes=unique(meta$clone)

# Initialize an empty data frame to store results
ks.stat <- data.frame(
  genes = character(),
  pval_vs_SCR = numeric(),
  padj_vs_SCR = numeric(),
  pval_vs_B2M = numeric(),
  padj_vs_B2M = numeric(),
  pval_greater_SCR= numeric(),
  pval_less_SCR= numeric(),
  ks_sign_SCR= numeric(),
  ks_greater_SCR= numeric(),
  ks_less_SCR= numeric(),
  pval_greater_B2M= numeric(),
  pval_less_B2M= numeric(),
  ks_sign_B2M= numeric(),
  ks_greater_B2m= numeric(),
  ks_less_B2M= numeric(),
  stringsAsFactors = FALSE
)

# Loop through genes
for (gene in genes) {
  # Subset data for the current gene
  gene_ecdf <- subset(meta, meta$clone == gene)
  gene_ecdf <- gene_ecdf$pseudotime

  # Subset SCR data
  SCR_ecdf <- subset(meta, meta$shRNA_gene == "SCR")
  SCR_ecdf <- SCR_ecdf$pseudotime
   # Subset B2M data
  B2M_ecdf <- subset(meta, meta$shRNA_gene == "B2M")
  B2M_ecdf <- B2M_ecdf$pseudotime

  # Perform ks.test
  ks.controls <- ks.test(gene_ecdf, SCR_ecdf)
  ks.controls_g <- ks.test(gene_ecdf, SCR_ecdf,alternative="greater")
  ks.controls_l <- ks.test(gene_ecdf, SCR_ecdf,alternative="less")
  
  ks.b2m <- ks.test(B2M_ecdf, gene_ecdf)
  ks.b2m_g <- ks.test(B2M_ecdf, gene_ecdf,alternative="greater")
  ks.b2m_l <- ks.test(B2M_ecdf, gene_ecdf,alternative="less")

  # Calculate adjusted p-values
  adj_vs_SCR <- p.adjust(ks.controls$p.value, method = "BH")
  adj_vs_B2M <- p.adjust(ks.b2m$p.value, method = "BH")

  # Append results to the data frame
  ks.stat <- bind_rows(
    ks.stat,
    data.frame(
      genes = gene,
      pval_vs_SCR = ks.controls$p.value,
      padj_vs_SCR = adj_vs_SCR,
      pval_greater_SCR=ks.controls_g[["p.value"]],
      pval_less_SCR=ks.controls_l[["p.value"]],
      ks_sign_SCR=ks.controls[["statistic"]][["D"]],
      ks_greater_SCR=ks.controls_g[["statistic"]][["D^+"]],
      ks_less_SCR=ks.controls_l[["statistic"]][["D^-"]],
      
      pval_vs_B2M = ks.b2m$p.value,
      padj_vs_B2M = adj_vs_B2M,
      pval_greater_B2M=ks.b2m_g[["p.value"]],
      pval_less_B2M=ks.b2m_l[["p.value"]],
      ks_sign_B2M=ks.b2m[["statistic"]][["D"]],
      ks_greater_B2m=ks.b2m_g[["statistic"]][["D^+"]],
      ks_less_B2M=ks.b2m_l[["statistic"]][["D^-"]]
    )
  )
}

# Add additional columns
ks.stat$sig_vs_SCR <- ks.stat$padj_vs_SCR <= 0.05
ks.stat$sig_vs_B2M <- ks.stat$padj_vs_B2M <= 0.05
ks.stat$greater_SCR <- ks.stat$pval_greater_SCR <= 0.05
ks.stat$less_SCR <- ks.stat$pval_less_SCR <= 0.05
ks.stat$greater_B2M <- ks.stat$pval_greater_B2M  <= 0.05
ks.stat$less_B2M <- ks.stat$pval_less_B2M  <= 0.05

ks.stat$k_sign_summary_SCR <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_SCR & !ks.stat$less_SCR,
  as.numeric(ks.stat$ks_sign_SCR),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_SCR & ks.stat$less_SCR,
    -as.numeric(ks.stat$ks_sign_SCR),  # Return negative of ks_sign
    ks.stat$ks_sign_SCR  # Otherwise, return 0
  )
)

ks.stat$k_sign_summary_B2M <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_B2M & !ks.stat$less_B2M,
  as.numeric(ks.stat$ks_sign_B2M),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_B2M & ks.stat$less_B2M,
    -as.numeric(ks.stat$ks_sign_B2M),  # Return negative of ks_sign
    ks.stat$ks_sign_B2M  # Otherwise, return 0
  )
)
ks.stat=ks.stat%>%dplyr::rename(clone=genes)
ks.stat=ks.stat%>%left_join(cl_ID,by="clone")
ks.stat= replace(ks.stat, is.na(ks.stat), "empty")

ks.stat$k_colour_SCR <- ifelse(
  ks.stat$sig_vs_SCR==T,ks.stat$clone_short,"") 

ks.clones=ks.stat
write.csv(ks.clones, file= paste0(fname_prefix_csv, "_", "_ks.stat_meso_clones.csv"), row.names=T)

######subset for not proliferant cells

meta=meta_clone_sub
# List of genes

genes=unique(meta$clone)

# Initialize an empty data frame to store results
ks.stat <- data.frame(
  genes = character(),
  pval_vs_SCR = numeric(),
  padj_vs_SCR = numeric(),
  pval_vs_B2M = numeric(),
  padj_vs_B2M = numeric(),
  pval_greater_SCR= numeric(),
  pval_less_SCR= numeric(),
  ks_sign_SCR= numeric(),
  ks_greater_SCR= numeric(),
  ks_less_SCR= numeric(),
  pval_greater_B2M= numeric(),
  pval_less_B2M= numeric(),
  ks_sign_B2M= numeric(),
  ks_greater_B2m= numeric(),
  ks_less_B2M= numeric(),
  stringsAsFactors = FALSE
)

# Loop through genes
for (gene in genes) {
  # Subset data for the current gene
  gene_ecdf <- subset(meta, meta$clone == gene)
  gene_ecdf <- gene_ecdf$pseudotime

  # Subset SCR data
  SCR_ecdf <- subset(meta, meta$shRNA_gene == "SCR")
  SCR_ecdf <- SCR_ecdf$pseudotime
   # Subset B2M data
  B2M_ecdf <- subset(meta, meta$shRNA_gene == "B2M")
  B2M_ecdf <- B2M_ecdf$pseudotime

  # Perform ks.test
  ks.controls <- ks.test(gene_ecdf, SCR_ecdf)
  ks.controls_g <- ks.test(gene_ecdf, SCR_ecdf,alternative="greater")
  ks.controls_l <- ks.test(gene_ecdf, SCR_ecdf,alternative="less")
  
  ks.b2m <- ks.test(B2M_ecdf, gene_ecdf)
  ks.b2m_g <- ks.test(B2M_ecdf, gene_ecdf,alternative="greater")
  ks.b2m_l <- ks.test(B2M_ecdf, gene_ecdf,alternative="less")

  # Calculate adjusted p-values
  adj_vs_SCR <- p.adjust(ks.controls$p.value, method = "BH")
  adj_vs_B2M <- p.adjust(ks.b2m$p.value, method = "BH")

  # Append results to the data frame
  ks.stat <- bind_rows(
    ks.stat,
    data.frame(
      genes = gene,
      pval_vs_SCR = ks.controls$p.value,
      padj_vs_SCR = adj_vs_SCR,
      pval_greater_SCR=ks.controls_g[["p.value"]],
      pval_less_SCR=ks.controls_l[["p.value"]],
      ks_sign_SCR=ks.controls[["statistic"]][["D"]],
      ks_greater_SCR=ks.controls_g[["statistic"]][["D^+"]],
      ks_less_SCR=ks.controls_l[["statistic"]][["D^-"]],
      
      pval_vs_B2M = ks.b2m$p.value,
      padj_vs_B2M = adj_vs_B2M,
      pval_greater_B2M=ks.b2m_g[["p.value"]],
      pval_less_B2M=ks.b2m_l[["p.value"]],
      ks_sign_B2M=ks.b2m[["statistic"]][["D"]],
      ks_greater_B2m=ks.b2m_g[["statistic"]][["D^+"]],
      ks_less_B2M=ks.b2m_l[["statistic"]][["D^-"]]
    )
  )
}

# Add additional columns
ks.stat$sig_vs_SCR <- ks.stat$padj_vs_SCR <= 0.05
ks.stat$sig_vs_B2M <- ks.stat$padj_vs_B2M <= 0.05
ks.stat$greater_SCR <- ks.stat$pval_greater_SCR <= 0.05
ks.stat$less_SCR <- ks.stat$pval_less_SCR <= 0.05
ks.stat$greater_B2M <- ks.stat$pval_greater_B2M  <= 0.05
ks.stat$less_B2M <- ks.stat$pval_less_B2M  <= 0.05

ks.stat$k_sign_summary_SCR <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_SCR & !ks.stat$less_SCR,
  as.numeric(ks.stat$ks_sign_SCR),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_SCR & ks.stat$less_SCR,
    -as.numeric(ks.stat$ks_sign_SCR),  # Return negative of ks_sign
    ks.stat$ks_sign_SCR  # Otherwise, return 0
  )
)

ks.stat$k_sign_summary_B2M <- ifelse(
  # "greater" is TRUE and "less" is FALSE
  ks.stat$greater_B2M & !ks.stat$less_B2M,
  as.numeric(ks.stat$ks_sign_B2M),  # Return ks_sign value
  ifelse(
    # "greater" is FALSE and "less" is TRUE
    !ks.stat$greater_B2M & ks.stat$less_B2M,
    -as.numeric(ks.stat$ks_sign_B2M),  # Return negative of ks_sign
    ks.stat$ks_sign_B2M  # Otherwise, return 0
  )
)
ks.stat=ks.stat%>%dplyr::rename(clone=genes)
ks.stat=ks.stat%>%left_join(cl_ID,by="clone")
ks.stat= replace(ks.stat, is.na(ks.stat), "empty")

ks.stat$k_colour_SCR <- ifelse(
  ks.stat$sig_vs_SCR==T,ks.stat$clone_short,"") 

ks.clones_sub=ks.stat
write.csv(ks.clones_sub, file= paste0(fname_prefix_csv, "_", "_ks.stat_meso_clones_sub.csv"), row.names=T)


```

####make volcano plot for ks results

```{r}
ID=ID_key%>%distinct(shRNA_gene,okabe_hex)
ks.clones=ks.clones%>%left_join(ID, by="shRNA_gene")
ks.clones_sub=ks.clones_sub%>%left_join(ID, by="shRNA_gene")

#ks.clones=ks.clones%>%left_join(col_genes, by="shRNA_gene")
ks.clones$k_colour_SCR <- ifelse(
  ks.clones$sig_vs_SCR==T,ks.clones$okabe_hex,"")

ks.clones$k_colour_B2M <- ifelse(
  ks.clones$sig_vs_B2M==T,ks.clones$okabe_hex,"")


data=subset(ks.clones,ks.clones$shRNA_gene!="B2M"&ks.clones$shRNA_gene!="empty"&ks.clones$shRNA_gene!="SCR")
g=data%>%select(shRNA_gene)%>%distinct(shRNA_gene)###make sure you have all the genes
p=col_genes%>%filter(shRNA_gene%in%g$shRNA_gene)

ggplot(data=subset(ks.clones,ks.clones$shRNA_gene!="B2M"&ks.clones$shRNA_gene!="empty"&ks.clones$shRNA_gene!="SCR"), aes(x=k_sign_summary_SCR, y=log10(padj_vs_SCR+1e-13)*-1)) +
  geom_point(aes(colour = factor(shRNA_gene,levels=c(p$shRNA_gene))), size=1.5) +
  scale_colour_manual(values=c(p$okabe_hex))+
  ggrepel::geom_text_repel(
    data = subset(ks.clones,ks.clones$shRNA_gene!="B2M"&ks.clones$shRNA_gene!="empty"&ks.clones$shRNA_gene!="SCR"&ks.clones$sig_vs_SCR==T),
    aes(label = clone_short),
    size = 3,
    max.overlaps=50,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  )+
  geom_hline(yintercept = log10(0.05)*-1,linetype="dotted", color="red")+
  geom_vline(xintercept = 0,linetype="dotted")+
  ggtitle("ks test statistics clones")+
  theme_minimal() +  # You can change the theme as needed
  labs(
    x = "KS statistic summary",
    y = "-Log10 adj p-value",
    color = "gene"  # Legend title
  ) 

ggsave(filename = paste0(fname_prefix_dotplot, "_volcano_ks_stats_clones.pdf"),
       width = 7, height = 4)

data=subset(ks.clones_sub,ks.clones_sub$shRNA_gene!="B2M"&ks.clones_sub$shRNA_gene!="empty"&ks.clones_sub$shRNA_gene!="SCR")
g=data%>%select(shRNA_gene)%>%distinct(shRNA_gene)###make sure you have all the genes
p=col_genes%>%filter(shRNA_gene%in%g$shRNA_gene)

ggplot(data=subset(ks.clones_sub,ks.clones_sub$shRNA_gene!="B2M"&ks.clones_sub$shRNA_gene!="empty"&ks.clones_sub$shRNA_gene!="SCR"), aes(x=k_sign_summary_B2M, y=log10(padj_vs_B2M)*-1)) +
  geom_point(aes(colour = factor(shRNA_gene,levels=c(p$shRNA_gene))), size=1.5) +
  scale_colour_manual(values=c(p$okabe_hex))+
  ggrepel::geom_text_repel(
    data = subset(ks.clones_sub,ks.clones$shRNA_gene!="B2M"&ks.clones_sub$shRNA_gene!="empty"&ks.clones_sub$shRNA_gene!="SCR"&ks.clones_sub$sig_vs_B2M==T),
    aes(label = clone_short),
    size = 3,
    max.overlaps=50,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  )+
  geom_hline(yintercept = log10(0.05)*-1,linetype="dotted", color="red")+
  geom_vline(xintercept = 0,linetype="dotted")+
  ggtitle("ks test statistics clones")+
  theme_minimal() +  # You can change the theme as needed
  labs(
    x = "KS statistic summary",
    y = "-Log10 adj p-value",
    color = "gene"  # Legend title
  ) 

ggsave(filename = paste0(fname_prefix_dotplot, "_volcano_ks_stats_clones_sub.pdf"),
       width = 7, height = 4)


```

